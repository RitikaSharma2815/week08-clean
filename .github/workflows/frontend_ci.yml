# .github/workflows/frontend_ci.yml
name: Frontend CI â€” build on dev/PR, push on main (if secrets)

on:
  workflow_dispatch:
  push:
    branches: [ dev, main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend_ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend_ci.yml'

permissions:
  contents: read
  id-token: write

concurrency:
  group: frontend-ci-${{ github.ref }}
  cancel-in-progress: true

# Mirror secrets into env so we can safely reference them in `if:` expressions
env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_TAG: ${{ github.sha }}-${{ github.run_id }}

jobs:
  # On dev/PR: verify the image builds locally (no push, no Azure)
  build_frontend_locally:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Docker build (no push)
        run: |
          docker build -t local/frontend:${{ env.IMAGE_TAG }} ./frontend

  # On main: build & push only if env (mirrored secrets) are present
  build_and_push_image:
    if: |
      needs.build_frontend_locally.result == 'success' &&
      github.ref == 'refs/heads/main' &&
      secrets.ACR_NAME != '' &&
      secrets.ACR_LOGIN_SERVER != ''
    runs-on: ubuntu-latest
    needs: build_frontend_locally
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name "${{ secrets.ACR_NAME }}"

      - name: Docker build & push
        run: |
          docker build -t "${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }}" ./frontend
          docker tag  "${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }}" "${{ secrets.ACR_LOGIN_SERVER }}/frontend:latest"
          docker push "${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }}"
          docker push "${{ secrets.ACR_LOGIN_SERVER }}/frontend:latest"

      - name: Azure Logout
        if: always()
        run: az logout
